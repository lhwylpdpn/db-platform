{% extends "base.html" %}
{% block content %}

<style>
    .select-title{
        background-color: #1B6AAA!important;
        border-color: #1B6AAA;
        color: #FFF;
    }
</style>
<div class="breadcrumbs ace-save-state" id="breadcrumbs">
    <ul class="breadcrumb">
        <li>
            <i class="ace-icon fa fa-home home-icon"></i>
            <a href="/">首页</a>
        </li>
        <li>
            <a href="#">用户分析</a>
        </li>
        <li>
            <a href="#">用户分析</a>
        </li>
        <li class="active">用户分析</li>
    </ul><!-- /.breadcrumb -->
</div>
<div class="page-content">

    <script src="/static/js/Filter_platform.js"></script><!--筛选需要的js-->
    <script type="text/javascript" src="/static/js/bootstrap-table.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap-table-multiple-sort.js"></script>
    <script type="text/javascript" src="/static/date_dropper/datedropper.js"></script>
    <link rel="stylesheet" href="/static/date_dropper/datedropper.css">
    <link rel="stylesheet" href="/static/css/bootstrap-table.css">
    <link rel="stylesheet" href="/static/css/Fliter.css">

    <div class="btn-group">
        <button id ="time_1" type="button" class="data-filter btn btn-white btn-sm btn-info btn-bold" >昨日</button>
        <button id ="time_2" type="button" class="data-filter btn btn-white btn-sm btn-info btn-bold">前日</button>
        <button id ="time_7" type="button" class="data-filter btn btn-white btn-sm btn-info btn-bold">近7天</button>
        <button id ="time_15" type="button" class="data-filter btn btn-white btn-sm btn-info btn-bold">近15天</button>
        <button id ="time_30" type="button" class="data-filter btn btn-white btn-sm btn-info btn-bold">近30天</button>
        <button id ="timeAll" type="button" class="data-filter btn btn-white btn-sm btn-info btn-bold">历史所有</button>
    </div>
    |<input value="选择自然月" type="text" class="data-filter btn btn-white btn-sm btn-primary" style="height:27px" id="month" />|
    <input id="timeFrom" type="date" class="data-filter btn btn-white btn-sm btn-primary" value="" style="height:27px"> --
    <input id="timeTo" type="date" class="data-filter btn btn-white btn-sm btn-primary" value="" style="height:27px">
    <p></p>
    <!-- Filter by Silence Begin -->
        <div id="FilterQuery" class="hotel-filter-list "><strong class="tit">已选</strong>
            <div class="conF selected-query">
                <ul id="FilterTagSelected">
                    <li class="filter-query-clear"><a id="FilterQueryClear" href="javascript:;">全部清除</a></li>
                </ul>
            </div>
        </div>
        <div id="FilterQueryList">
            <div id="List01" class="filterlist hotel-filter-list filter-list-has-more hotel-filter-list-min" data-value="platform">
                <strong class="tit">平台</strong>
                <div class="conF checkboxF">
                    <ul class="any">
                        <li><a class="filter-unlimit filter-tag selected" href="javascript:;">不限</a></li>
                    </ul>
                    <ul class="initial"></ul>
                    <ul class="list"></ul>
                    <span class="filter-more"><span class="open">更多</span><span class="closeF">收起</span><i></i></span>
                </div>
            </div>
            <div id="List02" class="filterlist hotel-filter-list filter-list-has-more hotel-filter-list-min" data-value="channel">
                <strong class="tit">媒体</strong>
                <div class="conF checkboxF">
                    <ul class="any">
                        <li><a class="filter-unlimit filter-tag selected" href="javascript:;">不限</a></li>
                    </ul>
                    <ul class="initial"></ul>
                    <ul class="list"></ul>
                    <span class="filter-more"><span class="open">更多</span><span class="closeF">收起</span><i></i></span>
                </div>
            </div>
            <div id="List03" class="filterlist hotel-filter-list filter-list-has-more hotel-filter-list-min" data-value="agent">
                <strong class="tit">代理</strong>
                <div class="conF checkboxF">
                    <ul class="any">
                        <li><a class="filter-unlimit filter-tag selected" href="javascript:;">不限</a></li>
                    </ul>
                    <ul class="initial"></ul>
                    <ul class="list"></ul>
                    <span class="filter-more"><span class="open">更多</span><span class="closeF">收起</span><i></i></span>
                </div>
            </div>
            <div id="List04" class="filterlist hotel-filter-list filter-list-has-more hotel-filter-list-min" data-value="staff">
                <strong class="tit">负责</strong>
                <div class="conF checkboxF">
                    <ul class="any">
                        <li><a class="filter-unlimit filter-tag selected" href="javascript:;">不限</a></li>
                    </ul>
                    <ul class="initial"></ul>
                    <ul class="list"></ul>
                    <span class="filter-more"><span class="open">更多</span><span class="closeF">收起</span><i></i></span>
                </div>
            </div>
        </div>
        <!-- Filter by Silence End -->
    <div>
        <div align="center" style="padding-top:7px">
            <button id="chaxun" class="btn btn-sm btn-primary" onclick="chaxun();">查询</button>
        </div>
    </div>

    <table id="table" data-sort-name="date_time" data-sort-order="desc" class="table table-bordered table-hover">
        <thead>
        <tr>
            <th data-field="game_id" data-sortable="true" data-align="right">
                game_id
            </th>
            <th data-field="platform" data-sortable="true">
                platform
            </th>
            <th data-field="channel_name" data-sortable="true" data-align="right">
                channel_name
            </th>
            <th data-field="agent" data-sortable="true" data-align="right">
                agent
            </th>
            <th data-field="date_time" data-sortable="true" data-align="right">
                date_time
            </th>
            <th data-field="ad_Creative" data-sortable="true" data-align="right">
                ad_Creative
            </th>
            <th data-field="accountid" data-sortable="true">
                accountid
            </th>


            <th data-field="logincount_0" data-sortable="true">
                +0登录
            </th>

            <th data-field="logincount_1" data-sortable="true">
                +1登录
            </th>
            <th data-field="logincount_2" data-sortable="true">
                +2登录
            </th>
            <th data-field="logincount_3" data-sortable="true">
                +3登录
            </th>

            <th data-field="logincount_4" data-sortable="true">
                +4登录
            </th>
            <th data-field="logincount_5" data-sortable="true">
                +5登录
            </th>
            <th data-field="logincount_6" data-sortable="true">
                +6登录
            </th>

            <th data-field="logincount_7" data-sortable="true">
                +7登录
            </th>


            <th data-field="re_0" data-sortable="true">
                +0充值
            </th>

            <th data-field="re_1" data-sortable="true">
                +1充值
            </th>
            <th data-field="re_2" data-sortable="true">
                +2充值
            </th>
            <th data-field="re_3" data-sortable="true">
                +3充值
            </th>

            <th data-field="re_4" data-sortable="true">
                +4充值
            </th>
            <th data-field="re_5" data-sortable="true">
                +5充值
            </th>
            <th data-field="re_6" data-sortable="true">
                +6充值
            </th>

            <th data-field="re_7" data-sortable="true">
                +7充值
            </th>


            <th data-field="online_0" data-sortable="true">
                +0活跃时长
            </th>

            <th data-field="online_1" data-sortable="true">
                +1活跃时长
            </th>
            <th data-field="online_2" data-sortable="true">
                +2活跃时长
            </th>
            <th data-field="online_3" data-sortable="true">
                +3活跃时长
            </th>

            <th data-field="online_4" data-sortable="true">
                +4活跃时长
            </th>
            <th data-field="online_5" data-sortable="true">
                +5活跃时长
            </th>
            <th data-field="online_6" data-sortable="true">
                +6活跃时长
            </th>

            <th data-field="online_7" data-sortable="true">
                +7活跃时长
            </th>


            <th data-field="level_0" data-sortable="true">
                +0 最高等级
            </th>

            <th data-field="level_1" data-sortable="true">
                +1 最高等级
            </th>
            <th data-field="level_2" data-sortable="true">
                +2 最高等级
            </th>
            <th data-field="level_3" data-sortable="true">
                +3 最高等级
            </th>

            <th data-field="level_4" data-sortable="true">
                +4 最高等级
            </th>
            <th data-field="level_5" data-sortable="true">
                +5 最高等级
            </th>
            <th data-field="level_6" data-sortable="true">
                +6 最高等级
            </th>

            <th data-field="level_7" data-sortable="true">
                +7 最高等级
            </th>

        </tr>
        </thead>
    </table>
</div><!-- /.page-content -->

<script type="text/javascript">

   // 时间筛选+条件筛选
   function chaxun(){

         $("#pannel_1").html("计算中");
         $("#pannel_2_1").html("计算中");
         $("#pannel_2_2").html("计算中");
         $("#pannel_2_3").html("计算中");
         $("#pannel_2").html("计算中");
         $("#pannel_3_1").html("计算中");
         $("#pannel_3_2").html("计算中");
         $("#pannel_4").html("计算中");
         $("#pannel_5").html("计算中");

        var TJ_platform= new Array();
        var TJ_staff= new Array();
        var TJ_agnet =new Array();
        var TJ_channel=new Array();
        var fromTime = $("#timeFrom").val();
        var toTime = $("#timeTo").val();

        var fromTimeCuo = Date.parse(new Date(fromTime));
        var toTimeCuo = Date.parse(new Date(toTime));
        var tianshu = (toTimeCuo - fromTimeCuo)/1000/60/60/24;

        var fromToTime = [fromTime];
        var flag = fromTimeCuo
        for (var i = 0 ; i < tianshu ; i++ ){
            flag = flag+1000*60*60*24;
            fromToTime.push( new Date(flag).Format("yyyy-MM-dd") );
        }

        $("#FilterTagSelected [data-platform]").each(function(){TJ_platform.push($(this).text());});
        $("#FilterTagSelected [data-channel]").each(function(){TJ_channel.push($(this).text());});
        $("#FilterTagSelected [data-agent]").each(function(){TJ_agnet.push($(this).text());});
        $("#FilterTagSelected [data-staff]").each(function(){TJ_staff.push($(this).text());});
 

        $("#table").bootstrapTable('refresh',{url: "/analyze/userAnalyzeJson?{{sjs}}&channel_name=" + TJ_channel.join(",") + "&platform=" + TJ_platform.join(",")+ "&agent=" + TJ_agnet.join(",") + "&staff=" + TJ_staff.join(",")} );

        $("#table").bootstrapTable('filterBy',{
            date_time : fromToTime,
        });

    }
</script>

<script type="text/javascript"> <!--开始设置数据格式-->
    // 对json进行按照指定key排序
    function sortByKey(array, key) {
        return array.sort(function(a, b) {
            var x = a[key]; var y = b[key];
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        });
    }

    /*
    将数值四舍五入后格式化.
    @param num 数值(Number或者String)
    @param cent 要保留的小数位(Number)
    @param isThousand 是否需要千分位 0:不需要,1:需要(数值类型);
    @return 格式的字符串,如'1,234,567.45'
    @type String
    */
    function formatNumber(num,cent,isThousand){

        num = num.toString().replace(/\$|\,/g,'');
        if(isNaN(num))//检查传入数值为数值类型.
         num = "0";
        if(isNaN(cent))//确保传入小数位为数值型数值.
        cent = 0;
        cent = parseInt(cent);
        cent = Math.abs(cent);//求出小数位数,确保为正整数.
        if(isNaN(isThousand))//确保传入是否需要千分位为数值类型.
        isThousand = 0;
        isThousand = parseInt(isThousand);
        if(isThousand < 0)
        isThousand = 0;
        if(isThousand >=1) //确保传入的数值只为0或1
        isThousand = 1;
        sign = (num == (num = Math.abs(num)));//获取符号(正/负数)
        //Math.floor:返回小于等于其数值参数的最大整数
        num = Math.floor(num*Math.pow(10,cent)+0.50000000001);//把指定的小数位先转换成整数.多余的小数位四舍五入.
        cents = num%Math.pow(10,cent); //求出小数位数值.
        num = Math.floor(num/Math.pow(10,cent)).toString();//求出整数位数值.
        cents = cents.toString();//把小数位转换成字符串,以便求小数位长度.
        while(cents.length<cent){//补足小数位到指定的位数.
        cents = "0" + cents;
        }
        if(isThousand == 0) //不需要千分位符.
        return (((sign)?'':'-') + num + '.' + cents);
        //对整数部分进行千分位格式化.
        for (var i = 0; i < Math.floor((num.length-(1+i))/3); i++)
        num = num.substring(0,num.length-(4*i+3))+','+
        num.substring(num.length-(4*i+3));
        return (((sign)?'':'-') + num + '.' + cents);

    }
    //千分位转化
    function toThousands(num) {
        return (num || 0).toString().replace(/(\d)(?=(?:\d{3})+$)/g, '$1,');
    }

</script><!--结束设置数据格式-->

<script type="text/javascript"> <!-- 初始化table -->
    $("#table").bootstrapTable({
        url: "/analyze/userAnalyzeJson?{{sjs}}&platform&channel_name&agent&staff",
        pagination: true, //开启分页
        pageSize: 10
    });

    $("#showHideTable").click(function(){
        $(".bootstrap-table").hide();
    });

</script><!-- 初始化table -->

<script type="text/javascript"> <!-- 日历筛选 -->
    Date.prototype.Format = function (fmt) { //author: meizz
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate(), //日
            "h+": this.getHours(), //小时
            "m+": this.getMinutes(), //分
            "s+": this.getSeconds(), //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds() //毫秒
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }

    //入参 2016-01-10格式的字符串
    function filterTime(fromTime,toTime){
        console.log(fromTime,toTime);
        //先将条件筛选清空
        $(".J_FilterQueryClear").trigger("click");

        var fromTimeCuo = Date.parse(new Date(fromTime));
        var toTimeCuo = Date.parse(new Date(toTime));
        var tianshu = (toTimeCuo - fromTimeCuo)/1000/60/60/24;

        var fromToTime = [fromTime];
        var flag = fromTimeCuo
        for (var i = 0 ; i < tianshu ; i++ ){
            flag = flag+1000*60*60*24;
            fromToTime.push( new Date(flag).Format("yyyy-MM-dd") );
        }
        //重新请求数据
        $("#table").bootstrapTable('refresh',{url: "/analyze/userAnalyzeJson?{{sjs}}&channel_name&agent&staff" } );

        $("#table").bootstrapTable('filterBy',{date_time : fromToTime});
    }

    $("#time_1").click(function(){
        var time = new Date();
        var timeTo = new Date(time - 1000*60*60*24).Format("yyyy-MM-dd");
        $("#timeFrom").val(timeTo);
        $("#timeTo").val(timeTo);
        //设置背景颜色,和其他去掉背景颜色
        $(".data-filter").addClass("btn-white");
        $(this).removeClass("btn-white");
        filterTime(timeTo, timeTo);
    });
    $("#time_2").click(function(){
        var time = new Date();
        var timeTo = new Date(time - 1000*60*60*24*2).Format("yyyy-MM-dd");
        $("#timeFrom").val(timeTo);
        $("#timeTo").val(timeTo);
        //设置背景颜色,和其他去掉背景颜色
        $(".data-filter").addClass("btn-white");
        $(this).removeClass("btn-white");
        filterTime(timeTo, timeTo);
    });
    $("#time_7").click(function(){
        var time = new Date();
        var timeTo = new Date(time - 1000*60*60*24).Format("yyyy-MM-dd");
        var timeFrom = new Date(time - 1000*60*60*24*7).Format("yyyy-MM-dd");
        $("#timeFrom").val(timeFrom);
        $("#timeTo").val(timeTo);
        //设置背景颜色,和其他去掉背景颜色
        $(".data-filter").addClass("btn-white");
        $(this).removeClass("btn-white");
        filterTime(timeFrom, timeTo);
    });
    $("#time_15").click(function(){
        var time = new Date();
        var timeTo = new Date(time - 1000*60*60*24).Format("yyyy-MM-dd");
        var timeFrom = new Date(time - 1000*60*60*24*15).Format("yyyy-MM-dd");
        $("#timeFrom").val(timeFrom);
        $("#timeTo").val(timeTo);
        //设置背景颜色,和其他去掉背景颜色
        $(".data-filter").addClass("btn-white");
        $(this).removeClass("btn-white");
        filterTime(timeFrom, timeTo);
    });
    $("#time_30").click(function(){
        var time = new Date();
        var timeTo = new Date(time - 1000*60*60*24).Format("yyyy-MM-dd");
        var timeFrom = new Date(time - 1000*60*60*24*30).Format("yyyy-MM-dd");
        $("#timeFrom").val(timeFrom);
        $("#timeTo").val(timeTo);
        //设置背景颜色,和其他去掉背景颜色
        $(".data-filter").addClass("btn-white");
        $(this).removeClass("btn-white");
        filterTime(timeFrom, timeTo);
    });

    $("#month").dateDropper({
        animate: false,
        format: 'Y-m',
        maxYear: '2017'
    });

    $("#month").change(function(){
        var flag = $(this).val();
        var timeFrom = new Date(flag).Format("yyyy-MM-dd");

        var timeTo = new Date(flag);
        timeTo.setMonth(timeTo.getMonth() + 1); //月份加1
        timeTo = new Date(timeTo.getTime()-1000*60*60*24).Format("yyyy-MM-dd");

        $("#timeFrom").val(timeFrom);
        $("#timeTo").val(timeTo);
        //设置背景颜色,和其他去掉背景颜色
        $(".data-filter").addClass("btn-white");
        $("#month").removeClass("btn-white");
        filterTime(timeFrom, timeTo);

    })

    $("#timeAll").click(function(){
        var time = new Date();
        var timeTo = new Date(time - 1000*60*60*24).Format("yyyy-MM-dd");
        var timeFrom = "2015-01-01";
        $("#timeFrom").val(timeFrom);
        $("#timeTo").val(timeTo);
        //设置背景颜色,和其他去掉背景颜色
        $(".data-filter").addClass("btn-white");
        $(this).removeClass("btn-white");
        filterTime(timeFrom, timeTo);
    });
    $("#timeFrom").change(function(){
        var timeFrom = $(this).val();
        var timeTo = $("#timeTo").val();
        //设置背景颜色,和其他去掉背景颜色
        $(".data-filter").addClass("btn-white");
        $(this).removeClass("btn-white");
        $("#timeTo").removeClass("btn-white");
        filterTime(timeFrom, timeTo);

    });
    $("#timeTo").change(function(){
        var timeTo = $(this).val();
        var timeFrom = $("#timeFrom").val();
        //设置背景颜色,和其他去掉背景颜色
        $(".data-filter").addClass("btn-white");
        $("#timeFrom").removeClass("btn-white");
        $(this).removeClass("btn-white");
        filterTime(timeFrom, timeTo);

    });

    //初始化From To
    $("#timeFrom").val("2015-01-01");

    var time = new Date();
    var timeTo = new Date(time - 1000*60*60*24).Format("yyyy-MM-dd");
    $("#timeTo").val(timeTo);

</script><!-- 日历筛选 -->

{% endblock content %}
